<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="style/game.css">
  <link rel="manifest" href="json/manifest.json">
  <link rel="shortcut icon" href="img/logos/favicon.ico" type="image/x-icon">
  <title>Webions</title>
</head>
<body>
  <noscript>
    This game will not apear without JavaScript - turn it on to play.
  </noscript>
  <div class="loader">
    <img src="img/logos/logo.webp" alt="Webions Game">
    <h1>WEBIONS</h1>
    <div class="loadDetails"></div>
  </div>
  <div class="wrapper">
    <div class="mobileControls leftPanel"></div>
    <div class="mobileControls rightPanel"></div>
    <div class="gamePlane">
      <canvas ></canvas>  
    </div>
  </div>
</body>
</html>
<!--| CLEAR OLD CACHE |-->
<script>
  // caches.open('v1').then(function(cache) {
  // cache.delete('/images/image.png').then(function(response) {
  //   someUIUpdateFunction();
  // });
  // })
</script>

<script src="js/functions.js"></script>
<script src="js/mapcontroller.js"></script>
<script src="js/sprites.js"></script>
<script src="js/controls.js"></script>

<!--| GAME PROPERTIES |-->
<script>
  const popup = {
    init(title = "GAME STOPPED."){
      this.dom = document.createElement("div");
      this.dom.style.cssText = `
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        width:100%;
        height:100%;
        position:fixed;
        left:0;
        top:0;
        z-index:3;
        background-color:rgba(0,0,0,0.8)
      `;
      this.h1 = document.createElement("h1");
      this.h1.innerHTML = title;
      this.button = document.createElement("button");
      this.button.style.position = "unset";
      this.button.style.padding = "10px 50px";
      this.button.onclick = () => {window.location.reload();}
      this.button.innerText = " PLAY. ";

      this.dom.append(this.h1);
      this.dom.append(this.button);
      document.body.append(this.dom);
    }
  }
  const urlParams = new URLSearchParams(window.location.search);
  let player = {};
  player.name = urlParams.get('player');
  if(player.name == null){
    player.name = "Newbie";
  }
  player.position = [0,0,0];

  let inGameConsole;
  const gamePlane = {
    fps : 10,
    actions: [],
    floors: [-1,0,1,2],
    creatures : {
      list: [],
      ids: []
    },
    sprites: [],
    canvas : document.querySelector(".gamePlane > canvas"),
    init () {
      this.canvas.width = 440;
      this.canvas.height = this.canvas.width;
      this.gridSize = 40;
      this.context = this.canvas.getContext("2d");
      inGameConsole = new Text();
      this.interval = setInterval(this.updategamePlane, 1000/gamePlane.fps);
      controls.init();
      window.addEventListener('keydown', function (e) {
        controls.update([e.keyCode,true]);
        // gamePlane.key = e.keyCode;
      })
      window.addEventListener('keyup', function (e) {
        controls.update([e.keyCode,false])
        // gamePlane.key = false;
      })
    },
    clear() {
      this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    },
    loadSprites(callback) {
      for(const s of sprites){
          this.sprites[s.name] = document.createElement("img");
          this.sprites[s.name].src = s.src;
      }
      callback();
    },
    updategamePlane() {
      gamePlane.clear();
      map.update();     
      serv.load();
      // let player = false;
      let playerIsSet = false;
      for(const ac of gamePlane.creatures.list){
        // console.log(ac)
        if(ac.name == player.name){
          player = ac;
          playerIsSet = true;
          continue;
        }
        ac.update();
      }
      // console.log()
      if(playerIsSet){
        player.update();
        for(const f of gamePlane.floors){
          map.draw(f);
          for(const ac of gamePlane.creatures.list){
            ac.draw(f);
          }
          player.draw(f);
        }
        for(const a of gamePlane.actions){a.update();}
        inGameConsole.update();
      }
    },
    stop(title = "GAME STOPPED."){
      // show popup
      popup.init(title);
      clearInterval(this.interval);
      console.log("Game stopped.")
    }
  }
</script>
<script src="js/components.js"></script>

<!--| WEBSOCKET SERVER CONNECTION |-->
<script>

  let protocol;(window.location.protocol == "https:")?protocol = "wss:":protocol = "ws:";
  const ws = new WebSocket(protocol+"//"+window.location.host+"/fetch/?name="+urlParams.get('player'),'echo-protocol');
  const serv = {
    connected:false,
    param : {},
    paramUpdate(){
      this.param.name = urlParams.get('player');
      this.param.id = false;
      this.param.controls = controls.vals;
      isSet(player.whiteTarget)?this.param.target = player.whiteTarget:'';
      return this.param;
    },
    load(){
      // set connection
      ws.onopen = () => {this.connected = true;}
      ws.onclose = () => {this.connected = false;}
      // send to server
      if(this.connected){
        // console.log(this.param.id);
        ws.send(JSON.stringify(this.paramUpdate()));
      }
      // get response
      ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        // console.log(data.game.player);
        // update game properties
        this.datetime = data.game.time;
        this.time = new Date(data.game.time).getTime();
        gamePlane.fps = data.game.fps;
        // show dev info
        dev.stats = data.game;
        dev.stats.player = player.name;
        dev.stats.position = player.position;
        // dev.stats.lastFrame = player.lastFrame;
        if(this.time - player.lastFrame > 3000){
          gamePlane.stop("Focus bro");
        }

        dev.stats.url = urlParams.get('player');
        dev.stats.ping = this.time - player.lastFrame;
        // dev.stats.ws = JSON.stringify(gamePlane.creatures.list);
        dev.update();


        // get names of online players
        let onlinePlayers = [];
        for(const p of data.creatures){
          if(p.type == "player"){
            onlinePlayers.push(p.name);
          }
        }

        // kick off offline players and update creature names
        for(const ac of gamePlane.creatures.list){
          if(!onlinePlayers.includes(ac.name) && ac.type == "enemy"){
            gamePlane.actions.push(new Action("misc",ac.position[0]+ac.x,ac.position[1]+ac.y,40,40,0));     
            gamePlane.creatures.list.splice(gamePlane.creatures.list.indexOf(ac),1);
            if(gamePlane.creatures.ids.includes(ac.id)){
              gamePlane.creatures.ids.splice(gamePlane.creatures.ids.indexOf(ac.id),1);
            }
            continue;
          }
          if(!gamePlane.creatures.ids.includes(ac.id)){
            gamePlane.creatures.ids.push(ac.id);
          }
        }
        
        // updating values
        for(const creature of data.creatures){
          let myChar;
          let charId;
          if(!gamePlane.creatures.ids.includes(creature.id)){
            if(creature.name == urlParams.get('player')){
              player = new Creature("player",player.position,urlParams.get('player')); 
              myChar = player;
            }else{
              let type = "monster";
              if(creature.type == "player"){type = "enemy";}
              myChar = new Creature(type,creature.position,creature.name);
            }
            gamePlane.creatures.list.push(myChar);
            charId = gamePlane.creatures.list.length-1;
            // charId = myChar.id;
          }else{
            // find it in gamePlane.creatures.list
            for(const [i,pl] of gamePlane.creatures.list.entries()){
              if(pl.id == creature.id){
                myChar = creature;
                charId = i;
              }
            }
            // update console
            if(creature.name == player.name && creature.text != ""){
              inGameConsole.text = creature.text;
              // console.log(creature.text);
            }
          }
          // updating values
          for(const key of Object.keys(creature)){
            if(key == "position"){
              if(!compareTables(gamePlane.creatures.list[charId]["newPos"],creature[key])){
                gamePlane.creatures.list[charId]["oldPos"] = gamePlane.creatures.list[charId]["newPos"];
                gamePlane.creatures.list[charId]["newPos"] = creature[key];
                gamePlane.creatures.list[charId]["walkingStart"] = serv.time;
              }
              continue;
            }
            if(key == "health"){gamePlane.creatures.list[charId]["oldHealth"] = gamePlane.creatures.list[charId]["health"];}
            if(key == "skills"){
              let oldExp;
              let oldLvl;
              if(gamePlane.creatures.list[charId].type == "player"
              && isSet(gamePlane.creatures.list[charId].skills)){
                if(gamePlane.creatures.list[charId].skills["exp"] != creature[key]["exp"]){
                  oldExp = gamePlane.creatures.list[charId].skills["exp"];
                }
                if(gamePlane.creatures.list[charId].skills["level"] != creature[key]["level"]){
                  oldLvl = gamePlane.creatures.list[charId].skills["level"];                  
                }
              }
              gamePlane.creatures.list[charId].skills = {};
              for(const k of Object.keys(creature[key])){
                if(k == "exp" && isSet(oldExp)){
                  gamePlane.creatures.list[charId].skills["oldExp"] = oldExp;
                }
                if(k == "level" && isSet(oldLvl)){
                  gamePlane.creatures.list[charId].skills["oldLvl"] = oldLvl;
                }
                gamePlane.creatures.list[charId].skills[k] = creature[key][k];
              }
              if(!isSet(oldExp)){gamePlane.creatures.list[charId].skills["oldExp"] = gamePlane.creatures.list[charId].skills["exp"];}
              if(!isSet(oldLvl)){gamePlane.creatures.list[charId].skills["oldLvl"] = gamePlane.creatures.list[charId].skills["level"];}
              continue;
            }
            if(key == "shotPosition"){
              gamePlane.creatures.list[charId].lastShotPosition = gamePlane.creatures.list[charId].shotPosition;
              gamePlane.creatures.list[charId].shotPosition = creature.shotPosition;
              continue;
            }
            if(key == "type"){continue;}
            gamePlane.creatures.list[charId][key] = creature[key];
          }
        }
      
        // callback(data)
      }
      // connection error
      ws.onerror = (error) => {
        gamePlane.stop();
        // console.log("Your connection is lost, ");
        console.log(error);
      }
    }
  }
</script>

<!--| PRELOAD |-->
<script>
  // preload ;>
  document.querySelector(".loadDetails").innerHTML = "Load sprites ...";
  gamePlane.loadSprites(()=>{
    serv.load();
    document.querySelector(".loadDetails").innerHTML = "Load map ...";
    map.generate(()=>{
      document.querySelector(".loadDetails").innerHTML = "Load game plane ...";
      gamePlane.init();
      document.querySelector(".loader").style.display = "none";
    })
  })
  // set elements resolution:
  mobileControls.preventZoom();
  setResolution();
  window.onresize = () =>{
    setResolution();  
  }
</script>

<!--| SERVICE WORKER FOR OFFLINE DISPLAY |-->
<script>
  if('serviceWorker' in navigator) {
    navigator.serviceWorker.register('serviceWorker.js');
  }
</script>

<!--| DEVELOPER BUTTONS & STATS |-->
<script>
  const dev = {
    init(){
      this.makeDevButt("STOP",()=>{gamePlane.stop()});
      this.makeDevButt("START",()=>{gamePlane.init()});
      this.makeStatsField();
      this.update();
    },
    makeDevButt(title,func){
      const butt = document.createElement("button");
      butt.onclick = () => { func()};
      butt.innerHTML =  title;
      document.body.append(butt);
    },
    makeStatsField(){
      this.statsDOM = document.createElement("div");
      this.statsDOM.innerHTML = "ELO :D"
      this.statsDOM.style.cssText = `
        width:30vw;
        position:fixed;
        right:0;
        top:0;
        padding:2%;
        font-size:0.6em;
        color:#000;
        background-color:rgba(255,255,255,0.8)
        `;
      document.body.append(this.statsDOM);
    },
    stats : {
      fps: 10,
      player: player.name
    },
    update(){
      if(typeof this.statsDOM != "undefined"){
        this.statsDOM.innerHTML = "";
        for(const s of Object.keys(this.stats)){
          if(s == "time"){
            const t = new Date(this.stats[s]);
            const time = t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();
            this.statsDOM.innerHTML += s +": "+time+"<br />";    
            continue;
          }
          this.statsDOM.innerHTML += s +": "+this.stats[s]+"<br />";
        }
      }
    }

  } 
  if(urlParams.get("dev") == "on"){
    dev.init();
  }
</script>

