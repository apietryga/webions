<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="style/game.css">
    <link rel="manifest" href="json/manifest.json">
    <link rel="shortcut icon" href="img/logos/favicon.ico" type="image/x-icon">
    <title>Webions</title>
  </head>
  <body>
    <noscript>
      This game will not apear without JavaScript - turn it on to play.
    </noscript>
    <div class="loader">
      <img src="img/logos/logo.webp" alt="Webions Game">
      <h1>WEBIONS</h1>
      <div class="loadDetails"></div>
    </div>
    <div class="wrapper">
      <div class="mobileControls leftPanel"></div>
      <div class="mobileControls rightPanel"></div>
      <div class="gamePlane">
        <canvas ></canvas>  
      </div>
    </div>
  </body>
</html>
<script src="js/functions.js?v={{version}}"></script>
<script src="js/sprites.js?v={{version}}"></script>
<script src="js/map.js?v={{version}}"></script>
<script>const map = new Map();</script>
<script src="js/controls.js?v={{version}}"></script>
<!-- POPUP -->
<script>
    const popup = {
    init(title = "GAME STOPPED."){
      this.dom = document.createElement("div");
      this.dom.style.cssText = `
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        width:100%;
        height:100%;
        position:fixed;
        left:0;
        top:0;
        z-index:3;
        `;
        // background-color:rgba(0,0,0,0.8)
      this.h1 = document.createElement("h1");
      this.h1.innerHTML = title;
      this.button = document.createElement("button");
      this.button.style.position = "unset";
      this.button.style.padding = "10px 50px";
      // this.button.onclick = () => {window.location.reload();}
      this.button.addEventListener(mobileControls.ev,() => {window.location.reload()});
      this.button.innerText = " PLAY. ";

      this.dom.append(this.h1);
      this.dom.append(this.button);
      document.body.append(this.dom);
    }
  }
</script>
<!-- PLAYER INIT SETTINGS -->
<script>
  const urlParams = new URLSearchParams(window.location.search);
  let player = {};
  player.name = urlParams.get('player');
  if(player.name == null){
    player.name = "Newbie";
  }
  player.position = [0,0,0];
</script>
<!--| GAMEPLANE PROPERTIES |-->
<script src="js/client/gameplane.js?v={{version}}"></script>
<script src="js/client/components.js?v={{version}}"></script>
<!--| WEBSOCKET SERVER CONNECTION |-->
<script src="js/client/websocket.js?v={{version}}"></script>
<!--| PRELOAD |-->
<script>
  // preload ;>
  document.querySelector(".loadDetails").innerHTML = "Load sprites ...";
  map.loadSprites(()=>{
    serv.load();
    document.querySelector(".loadDetails").innerHTML = "Load map ...";
    map.generate(()=>{
      document.querySelector(".loadDetails").innerHTML = "Load game plane ...";
      gamePlane.init();
      document.querySelector(".loader").style.display = "none";
    })
  })
  // set elements resolution:
  setResolution();
  window.onresize = () =>{
    setResolution();  
  }
</script>
<!--| SERVICE WORKER FOR OFFLINE DISPLAY |-->
<script>
  if('serviceWorker' in navigator) {
    // serviceWorkerRegistration.update();
    navigator.serviceWorker.register('serviceWorker.js'
    // , {scope: 'serviceWorker'}).then(function(registration) {
    //   registration.update();
    // }
    );
  }
  
</script>
<!--| DEVELOPER BUTTONS & STATS |-->
<script>
  const dev = {
    buttonIndex : 0,
    init(){
      this.makeDevButt("STOP",()=>{gamePlane.stop()});
      this.makeDevButt("UPDATE",()=>{gamePlane.updategamePlane()});
      // this.makeDevButt("START",()=>{gamePlane.init()});
      this.makeStatsField();
      this.update();
    },
    makeDevButt(title,func){
      const butt = document.createElement("button");
      // butt.onclick = () => { func()};
      butt.addEventListener(mobileControls.ev,func);
      butt.innerHTML =  title;
      butt.style.zIndex = 4;
      document.body.append(butt);
      butt.style.marginTop = ((butt.clientHeight+10)*this.buttonIndex)+ "px";
      this.buttonIndex++;
    },
    makeStatsField(){
      this.statsDOM = document.createElement("div");
      this.statsDOM.innerHTML = "ELO :D"
      this.statsDOM.style.cssText = `
        width:30vw;
        position:fixed;
        right:0;
        top:0;
        padding:2%;
        font-size:0.6em;
        color:#000;
        background-color:rgba(255,255,255,0.8);
        z-index:4;
        `;
      document.body.append(this.statsDOM);
    },
    stats : {
      fps: 10,
      player: player.name
    },
    update(){
      if(typeof this.statsDOM != "undefined"){
        this.statsDOM.innerHTML = "";
        for(const s of Object.keys(this.stats)){
          if(s == "time"){
            const t = new Date(this.stats[s]);
            const time = t.getHours()+":"+t.getMinutes()+":"+t.getSeconds();
            this.statsDOM.innerHTML += s +": "+time+"<br />";    
            continue;
          }
          this.statsDOM.innerHTML += s +": "+this.stats[s]+"<br />";
        }
      }
    }
  } 
  if(urlParams.get("dev") == "on"){
    dev.init();
  }
</script>
{{version}}
